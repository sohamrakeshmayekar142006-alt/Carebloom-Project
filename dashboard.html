<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Donor Dashboard - CareBloom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
      .otp-input {
        width: 50px; height: 50px; text-align: center; font-size: 1.25rem;
        border: 2px solid #d1d5db; border-radius: 8px; margin: 0 5px; transition: border-color 0.2s;
      }
      .otp-input:focus {
        outline: none; border-color: #ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
      }
      .progress-bar {
        background-color: #e5e7eb; border-radius: 9999px; height: 0.75rem; overflow: hidden;
      }
      .progress-fill {
        background-color: #ec4899; height: 100%; transition: width 0.5s ease-in-out;
      }
    </style>
  </head>
  <body class="bg-gradient-to-r from-pink-100 via-rose-100 to-orange-100 min-h-screen">
    <div class="flex min-h-screen">
      <aside class="w-64 flex-shrink-0 bg-amber-50 shadow-lg flex flex-col">
        <div class="p-6 text-2xl font-bold text-center border-b">üå±Care<span class="text-pink-600">Bloom</span></div>
        <nav class="flex-grow p-4 space-y-2">
            <a href="#" id="nav-dashboard" class="nav-link flex items-center px-4 py-3 font-semibold text-white bg-pink-500 rounded-lg">
                <i class="fas fa-tachometer-alt w-6 text-center mr-3"></i>Dashboard
            </a>
            <a href="#" id="nav-donations" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
                <i class="fas fa-gift w-6 text-center mr-3"></i>My Donations
            </a>
            <a href="#" id="nav-requests" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
                <i class="fas fa-handshake w-6 text-center mr-3"></i>Donation Requests
            </a>
            <a href="#" id="nav-delivery-process" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
              <i class="fas fa-route w-6 text-center mr-3"></i>Delivery Process
            </a>
            <a href="#" id="nav-tracking" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
                <i class="fas fa-shipping-fast w-6 text-center mr-3"></i>Delivery Tracking
            </a>
            <a href="#" id="nav-profile" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
                <i class="fas fa-user w-6 text-center mr-3"></i>Profile
            </a>
            <a href="#" id="nav-redemption" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
                <i class="fas fa-star w-6 text-center mr-3"></i>Redemption
            </a>
            <a href="#" id="nav-feedback" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
                <i class="fas fa-comment-dots w-6 text-center mr-3"></i>Feedback
            </a>
        </nav>
        <div class="p-4 border-t">
            <a href="#" id="nav-logout" class="flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 rounded-lg">
                <i class="fas fa-sign-out-alt w-6 text-center mr-3"></i>Logout
            </a>
        </div>
      </aside>

      <main class="flex-1 p-6">
        <div id="view-dashboard">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-6 mb-6">
            <h1 class="font-bold text-black text-3xl">Welcome, <span id="user-name">User</span>! üå∑</h1>
            <p class="mt-1.5 text-xl font-normal text-black">
              Your Garden is Flourishing! You have helped <span id="ngo-count">0</span> NGOs and Touched <span id="lives-touched">0</span> Lives! üéóÔ∏è
            </p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
              <div class="text-3xl font-bold text-pink-600 mb-2" id="total-donations">0</div>
              <div class="text-gray-600">Total Donations</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
              <div class="text-3xl font-bold text-green-600 mb-2" id="pending-requests">0</div>
              <div class="text-gray-600">Pending Requests</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
              <div class="text-3xl font-bold text-blue-600 mb-2" id="active-deliveries">0</div>
              <div class="text-gray-600">Active Deliveries</div>
            </div>
          </div>
          <section class="donation-form bg-amber-50 rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl text-black font-bold mb-6">Plant a New Seed (Make a new donation) üå±</h2>
            <form id="donation-form" class="space-y-6">
              <div>
                <label for="item-name" class="block text-xl text-black font-medium mb-2">Item Name</label>
                <input id="item-name" type="text" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400" placeholder="e.g., Winter Jacket">
              </div>
              <div>
                <label for="quantity-required" class="block text-xl text-black font-medium mb-2">Quantity</label>
                <input id="quantity-required" type="text" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400" placeholder="e.g., 5 jackets">
              </div>
              <div>
                <label for="item-images" class="block text-xl text-black font-medium mb-2">Add Photos</label>
                <div class="image-upload-area relative flex flex-col justify-center items-center p-8 border-2 border-dashed border-pink-500 rounded-lg cursor-pointer bg-pink-50 hover:bg-pink-100 transition-colors duration-200 min-h-[200px]">
                  <input type="file" id="item-images" accept="image/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                  <div class="text-center">
                    <i class="fa-solid fa-camera text-4xl text-pink-600 mb-2"></i>
                    <p class="text-gray-700">Drag & Drop or click to browse</p>
                    <p class="text-sm text-gray-500 mt-1">Max file size: 5MB</p>
                  </div>
                  <div id="image-preview-container" class="flex flex-wrap gap-4 mt-4 justify-center"></div>
                </div>
              </div>
              <div>
                <label for="item-description" class="block text-xl text-black font-medium mb-2">Item Description</label>
                <textarea id="item-description" rows="4" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400" placeholder="Describe the item's condition, size, etc."></textarea>
              </div>
              <div>
                <label class="block text-xl text-black font-medium mb-2">Select Tag</label>
                <div class="flex flex-wrap gap-2" id="tag-buttons">
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Books</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Clothes</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Toys</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Utensils</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Electronics</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Small furniture</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Sports Equipment</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Bedding & Blankets</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Towels</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Baby Gear (strollers, car seats)</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Feminine Hygiene Products</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">First-Aid Supplies</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Medical Aids (Wheelchairs, Crutches)</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Tools & Hardware</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Pet Supplies</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Cleaning Supplies</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Home Appliances (Small)</button>
                    <button type="button" class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors">Others</button>
                </div>
                <input type="hidden" id="selected-tag" />
              </div>
              <button id="donate-item-btn" type="button" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 transition-colors">Donate Item</button>
            </form>
          </section>
        </div>
        <div id="view-donations" class="hidden">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
            <h1 class="font-bold text-black text-3xl mb-6">My Donations üéÅ</h1>
            <div id="donations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
          </div>
        </div>
        <div id="view-requests" class="hidden">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
            <h1 class="font-bold text-black text-3xl mb-6">Donation Requests ü§ù</h1>
            <div id="requests-container" class="space-y-6"></div>
          </div>
        </div>
        <div id="view-delivery-process" class="hidden">
            <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
                <h1 class="font-bold text-black text-3xl mb-6">Delivery Process üöö</h1>
                <div id="delivery-process-content"></div>
            </div>
        </div>
        <div id="view-tracking" class="hidden">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
            <h1 class="font-bold text-black text-3xl mb-6">Delivery Tracking üöö</h1>
            <div id="tracking-container" class="space-y-6"></div>
          </div>
        </div>
        <div id="view-profile" class="hidden">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
            <div class="flex justify-between items-start mb-6">
                <h1 class="font-bold text-black text-3xl">My Profile üë§</h1>
                <div id="profile-badges" class="flex items-center gap-3"></div>
            </div>
            <form id="profile-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="profile-first-name" class="block text-xl font-medium mb-2">First Name</label>
                        <input id="profile-first-name" type="text" required class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                    <div>
                        <label for="profile-last-name" class="block text-xl font-medium mb-2">Last Name</label>
                        <input id="profile-last-name" type="text" required class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    </div>
                </div>
                <div>
                    <label for="profile-email" class="block text-xl font-medium mb-2">Email</label>
                    <input id="profile-email" type="email" disabled class="w-full px-4 py-2 rounded-lg bg-gray-100 cursor-not-allowed">
                </div>
                <div>
                    <label for="profile-phone-number" class="block text-xl font-medium mb-2">Phone Number</label>
                    <input id="profile-phone-number" type="tel" required class="w-full px-4 py-2 rounded-lg border border-gray-300">
                </div>
                <div>
                    <label for="profile-age" class="block text-xl font-medium mb-2">Age</label>
                    <input id="profile-age" type="number" required class="w-full px-4 py-2 rounded-lg border border-gray-300">
                </div>
                <div>
                    <label for="profile-pin-code" class="block text-xl font-medium mb-2">Pincode</label>
                    <input id="profile-pin-code" type="text" required class="w-full px-4 py-2 rounded-lg border border-gray-300">
                </div>
                <div>
                    <label for="profile-address" class="block text-xl font-medium mb-2">Full Address</label>
                    <textarea id="profile-address" rows="3" required class="w-full px-4 py-2 rounded-lg border border-gray-300"></textarea>
                </div>
                <button id="update-profile-btn" type="submit" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700">
                    Update Profile
                </button>
            </form>
          </div>
        </div>
        <div id="view-redemption" class="hidden">
            <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
                <div class="flex justify-between items-start mb-6">
                    <h1 class="font-bold text-black text-3xl">Redeem Your Rewards ‚≠ê</h1>
                    <div id="redemption-badges" class="flex items-center gap-3"></div>
                </div>
                <div id="redemption-content"></div>
            </div>
        </div>
        <div id="view-feedback" class="hidden">
            <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
                <h1 class="font-bold text-black text-3xl mb-6">Share Your Feedback üí¨</h1>
                <form id="feedback-form">
                    <label for="feedback-text" class="block text-lg font-medium mb-2">How can we improve?</label>
                    <textarea id="feedback-text" rows="6" class="w-full p-4 border rounded-lg" placeholder="Type your feedback here..."></textarea>
                    <button type="submit" class="mt-4 w-full bg-pink-500 text-white font-bold py-3 rounded-lg hover:bg-pink-700">Submit Feedback</button>
                </form>
            </div>
        </div>
      </main>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-pink-100 mb-4"><i class="fas fa-hand-holding-heart text-pink-600 text-2xl"></i></div><h3 class="text-lg font-medium text-gray-900">Confirm Donation</h3><p class="mt-2 text-sm text-gray-500">Are you sure you want to list this item for donation?</p><div class="mt-6 flex justify-center gap-4"><button id="confirm-donate-btn" type="button" class="bg-pink-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-pink-700">Yes, Donate</button><button id="cancel-donate-btn" type="button" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">No, Cancel</button></div></div></div>
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"><i class="fas fa-check text-green-600 text-2xl"></i></div><h3 class="text-lg font-medium text-gray-900">Success!</h3><p class="mt-2 text-sm text-gray-500">Item donated successfully!</p><div class="mt-6"><button id="success-ok-btn" type="button" class="w-full bg-pink-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-pink-700">Okay</button></div></div></div>
    <div id="request-decision-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6"><h3 class="text-lg font-medium text-gray-900 mb-4" id="request-modal-title">Donation Request</h3><div id="request-modal-content"></div><div class="mt-6 flex justify-center gap-4"><button id="accept-request-btn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Accept</button><button id="reject-request-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Reject</button><button id="cancel-request-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button></div></div></div>
    <div id="delivery-success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"><i class="fas fa-check text-green-600 text-2xl"></i></div><h3 class="text-lg font-medium text-gray-900">Delivery Update</h3><p id="delivery-success-message" class="mt-2 text-sm text-gray-500"></p><div class="mt-6"><button id="delivery-ok-btn" type="button" class="w-full bg-pink-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-pink-700">Okay</button></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const session = await window.authHelper.checkAuth();
        if (!session) { window.location.href = 'LoginSignUp.html'; return; }
        const { data: donorProfile, error } = await window.authHelper.supabase.from('donor_profiles').select('id, first_name').eq('id', session.user.id).single();
        if (error || !donorProfile) { window.location.href = 'CreateProfile.html'; return; }
        
        let currentUser = session.user;
        let fileStore = new DataTransfer();
        let currentRequestId = null;

        await loadUserData();
        initializeEventListeners();
        
        function switchView(viewName) {
            document.querySelectorAll('main > div[id^="view-"]').forEach(view => view.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-pink-500', 'text-white');
                link.classList.add('text-gray-600', 'hover:bg-pink-100');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            const activeNav = document.getElementById(`nav-${viewName}`);
            activeNav.classList.remove('text-gray-600', 'hover:bg-pink-100');
            activeNav.classList.add('bg-pink-500', 'text-white');

            if (viewName === 'donations') loadDonations();
            else if (viewName === 'requests') loadDonationRequests();
            else if (viewName === 'delivery-process') loadAcceptedDonationsForDelivery();
            else if (viewName === 'tracking') loadDeliveryTracking();
            else if (viewName === 'profile') loadProfileData();
            else if (viewName === 'redemption') loadRedemptionData();
        }

        function initializeEventListeners() {
            initializeImageUpload();
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.currentTarget.id.replace('nav-', ''));
                });
            });
            document.getElementById('nav-logout').addEventListener('click', async (e) => { e.preventDefault(); await window.authHelper.logoutUser(); });
            document.getElementById('donate-item-btn').addEventListener('click', () => { if (validateDonationForm()) document.getElementById('confirmation-modal').classList.remove('hidden'); });
            document.getElementById('confirm-donate-btn').addEventListener('click', submitDonation);
            document.getElementById('cancel-donate-btn').addEventListener('click', () => document.getElementById('confirmation-modal').classList.add('hidden'));
            document.getElementById('success-ok-btn').addEventListener('click', () => {
                document.getElementById('success-modal').classList.add('hidden');
                document.getElementById('donation-form').reset();
                document.getElementById('image-preview-container').innerHTML = '';
                fileStore = new DataTransfer();
                document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('bg-pink-500', 'text-white'));
                document.getElementById('selected-tag').value = '';
            });
            document.getElementById('accept-request-btn').addEventListener('click', () => handleRequestDecision('accepted'));
            document.getElementById('reject-request-btn').addEventListener('click', () => handleRequestDecision('rejected'));
            document.getElementById('cancel-request-btn').addEventListener('click', () => document.getElementById('request-decision-modal').classList.add('hidden'));
            let tagButtons = document.querySelectorAll(".tag-btn");
            let selectedTagInput = document.getElementById("selected-tag");
            let selectedTagBtn = null;
            tagButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    if (selectedTagBtn === btn) { btn.classList.remove("bg-pink-500", "text-white"); selectedTagBtn = null; selectedTagInput.value = ""; } 
                    else {
                        tagButtons.forEach(b => b.classList.remove("bg-pink-500", "text-white"));
                        btn.classList.add("bg-pink-500", "text-white"); selectedTagBtn = btn; selectedTagInput.value = btn.textContent.trim();
                    }
                });
            });
            document.getElementById('profile-form').addEventListener('submit', updateProfile);
            document.getElementById('feedback-form').addEventListener('submit', handleFeedbackSubmit);
            document.getElementById('delivery-ok-btn').addEventListener('click', () => {
                document.getElementById('delivery-success-modal').classList.add('hidden');
                switchView('delivery-process');
            });
        }
        
        async function loadUserData() {
            const { data: profile } = await window.authHelper.supabase.from('donor_profiles').select('*').eq('id', currentUser.id).single();
            if (profile) {
                document.getElementById('user-name').textContent = profile.first_name;
                await updateDashboardStats();
                await loadProfileData();
            }
        }

        async function updateDashboardStats() {
            const { data, count } = await window.authHelper.supabase.from('donations').select('status', { count: 'exact' }).eq('donor_id', currentUser.id);
            if (data) {
                document.getElementById('total-donations').textContent = count;
                const completed = data.filter(d => d.status === 'delivered');
                document.getElementById('ngo-count').textContent = new Set(completed.map(d => d.ngo_id)).size;
            }
            const { count: reqCount } = await window.authHelper.supabase.from('donation_requests').select('id', { count: 'exact' }).eq('donor_id', currentUser.id).eq('status', 'pending');
            document.getElementById('pending-requests').textContent = reqCount || 0;
            const { count: delivCount } = await window.authHelper.supabase.from('delivery_tracking').select('id', { count: 'exact' }).eq('donor_id', currentUser.id).in('status', ['pickup_pending', 'in_transit']);
            document.getElementById('active-deliveries').textContent = delivCount || 0;
        }

        function initializeImageUpload() {
            const fileInput = document.getElementById('item-images');
            const previewContainer = document.getElementById('image-preview-container');
            fileInput.addEventListener('change', (event) => {
                fileStore = new DataTransfer();
                for (const file of event.target.files) fileStore.items.add(file);
                renderPreviews();
            });
            function renderPreviews() {
                previewContainer.innerHTML = "";
                for (let i = 0; i < fileStore.files.length; i++) {
                    const file = fileStore.files[i];
                    if (!file.type.startsWith("image/")) continue;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wrapper = document.createElement("div");
                        wrapper.className = "relative w-24 h-24";
                        wrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg border-2"><button type="button" onclick="removeFile(${i})" class="absolute top-0 right-0 -m-2 w-6 h-6 bg-red-500 text-white rounded-full">&times;</button>`;
                        previewContainer.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                }
            }
            window.removeFile = (index) => {
                const newFiles = new DataTransfer();
                for (let i = 0; i < fileStore.files.length; i++) { if (i !== index) newFiles.items.add(fileStore.files[i]); }
                fileStore = newFiles; fileInput.files = newFiles.files; renderPreviews();
            }
        }

        function validateDonationForm() {
            const form = document.getElementById('donation-form');
            if (!form.checkValidity()) { form.reportValidity(); return false; }
            if (!document.getElementById('selected-tag').value) { alert('Please select a tag.'); return false; }
            return true;
        }

        async function submitDonation() {
            const itemName = document.getElementById('item-name').value;
            const quantity = document.getElementById('quantity-required').value;
            const description = document.getElementById('item-description').value;
            const tag = document.getElementById('selected-tag').value;
            try {
                const { data: donorProfile } = await window.authHelper.supabase.from('donor_profiles').select('address, pin_code').eq('id', currentUser.id).single();
                let imageUrls = [];
                if (fileStore.files.length > 0) {
                    for (let i = 0; i < fileStore.files.length; i++) {
                        const file = fileStore.files[i];
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${currentUser.id}_${Date.now()}_${i}.${fileExt}`;
                        const { error: uploadError } = await window.authHelper.supabase.storage.from('donation-images').upload(`public/${fileName}`, file);
                        if (uploadError) throw uploadError;
                        const { data } = window.authHelper.supabase.storage.from('donation-images').getPublicUrl(`public/${fileName}`);
                        imageUrls.push(data.publicUrl);
                    }
                }
                await window.authHelper.supabase.from('donations').insert([{
                    donor_id: currentUser.id, item_name: itemName, quantity_required: quantity,
                    description: description, item_tag: tag, item_image_url: imageUrls.join(','),
                    donor_pincode: donorProfile.pin_code, donor_address: donorProfile.address, status: 'available'
                }]);
                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('success-modal').classList.remove('hidden');
                await updateDashboardStats();
            } catch (error) { alert('Failed to submit donation: ' + error.message); }
        }

        async function loadDonations() {
            const { data: donations } = await window.authHelper.supabase.from('donations').select('*').eq('donor_id', currentUser.id).order('created_at', { ascending: false });
            const container = document.getElementById('donations-container');
            container.innerHTML = donations && donations.length > 0 ? donations.map(d => {
                const imageUrl = d.item_image_url ? d.item_image_url.split(',')[0] : 'https://placehold.co/400x300/FFC0CB/333333?text=No+Image';
                return `<div class="bg-white rounded-xl shadow-md p-6"><img src="${imageUrl}" class="w-full h-48 object-cover rounded-lg mb-4"><h3 class="text-xl font-semibold">${d.item_name}</h3><p class="text-gray-600">Qty: ${d.quantity_required}</p><p class="text-gray-600">Status: <span class="font-semibold ${getStatusColor(d.status)}">${d.status}</span></p><p class="text-xs mt-2 text-gray-400">${new Date(d.created_at).toLocaleDateString()}</p></div>`;
            }).join('') : '<p class="col-span-full text-center text-gray-500">You haven\'t made any donations yet.</p>';
        }

        async function loadDonationRequests() {
            const { data: requests } = await window.authHelper.supabase.from('donation_requests').select(`*, donations(*), ngo_profiles(ngo_name, city, state)`).eq('donor_id', currentUser.id).order('created_at', { ascending: false });
            const container = document.getElementById('requests-container');
            container.innerHTML = requests && requests.length > 0 ? requests.map(request => {
                const donation = request.donations;
                const ngo = request.ngo_profiles;
                const imageUrl = donation.item_image_url ? donation.item_image_url.split(',')[0] : 'https://placehold.co/400x300/FFC0CB/333333?text=No+Image';
                return `<div class="bg-white rounded-xl shadow-lg p-6 flex items-start gap-4"><img src="${imageUrl}" alt="${donation.item_name}" class="w-24 h-24 object-cover rounded-lg flex-shrink-0"><div class="flex-1"><div class="flex justify-between items-start mb-2"><h3 class="text-xl font-semibold">${donation.item_name}</h3><span class="px-3 py-1 rounded-full text-sm font-medium ${getRequestStatusColor(request.status)}">${request.status}</span></div><div class="space-y-1 text-sm"><p><strong>NGO:</strong> ${ngo.ngo_name}</p><p><strong>Location:</strong> ${ngo.city}, ${ngo.state}</p><p><strong>Requested on:</strong> ${new Date(request.created_at).toLocaleDateString()}</p></div>${request.status === 'pending' ? `<div class="mt-3 flex gap-2"><button onclick="showRequestDecisionModal('${request.id}')" class="bg-pink-500 text-white px-4 py-2 text-sm rounded-lg hover:bg-pink-700">Review Request</button></div>` : ''}</div></div>`;
            }).join('') : '<p class="text-center text-gray-500">No pending requests at the moment.</p>';
        }

        async function loadDeliveryTracking() {
            const { data: tracking } = await window.authHelper.supabase.from('delivery_tracking').select(`*, donations(item_name, item_image_url), ngo_profiles(ngo_name, address)`).eq('donor_id', currentUser.id).order('created_at', { ascending: false });
            const container = document.getElementById('tracking-container');
            container.innerHTML = tracking && tracking.length > 0 ? tracking.map(track => {
                const donation = track.donations;
                const ngo = track.ngo_profiles;
                const imageUrl = donation.item_image_url ? donation.item_image_url.split(',')[0] : 'https://placehold.co/400x300/FFC0CB/333333?text=No+Image';
                return `<div class="bg-white rounded-xl shadow-lg p-6 flex items-start gap-4"><img src="${imageUrl}" class="w-24 h-24 object-cover rounded-lg"><div class="flex-1"><div class="flex justify-between items-start mb-2"><h3 class="text-xl font-semibold">${donation.item_name}</h3><span class="px-3 py-1 rounded-full text-sm font-medium ${getTrackingStatusColor(track.status)}">${track.status.replace(/_/g, ' ').toUpperCase()}</span></div><div class="space-y-2 text-sm"><p><strong>Tracking ID:</strong> ${track.tracking_id}</p><p><strong>NGO:</strong> ${ngo.ngo_name}</p><p><strong>Status:</strong> ${track.status_description || 'Pending'}</p></div></div></div>`;
            }).join('') : '<p class="text-center text-gray-500">No active deliveries to track.</p>';
        }

        async function loadProfileData() {
            const { data: profile } = await window.authHelper.supabase.from('donor_profiles').select('*').eq('id', currentUser.id).single();
            if (profile) {
                document.getElementById('profile-first-name').value = profile.first_name || '';
                document.getElementById('profile-last-name').value = profile.last_name || '';
                document.getElementById('profile-email').value = profile.email || '';
                document.getElementById('profile-phone-number').value = profile.phone_number || '';
                document.getElementById('profile-age').value = profile.age || '';
                document.getElementById('profile-pin-code').value = profile.pin_code || '';
                document.getElementById('profile-address').value = profile.address || '';
            }
            const { count } = await window.authHelper.supabase.from('donations').select('*', { count: 'exact', head: true }).eq('donor_id', currentUser.id);
            const badgesContainer = document.getElementById('profile-badges');
            badgesContainer.innerHTML = '';
            if (count >= 10) { badgesContainer.innerHTML += `<div class="flex flex-col items-center" title="Bronze Donor: 10+ Donations"><i class="fas fa-medal text-orange-400 text-3xl"></i><span class="text-xs font-medium text-gray-600">Bronze</span></div>`; }
            if (count >= 20) { badgesContainer.innerHTML += `<div class="flex flex-col items-center" title="Silver Donor: 20+ Donations"><i class="fas fa-medal text-gray-400 text-3xl"></i><span class="text-xs font-medium text-gray-600">Silver</span></div>`; }
            if (count >= 50) { badgesContainer.innerHTML += `<div class="flex flex-col items-center" title="Gold Donor: 50+ Donations"><i class="fas fa-medal text-yellow-500 text-3xl"></i><span class="text-xs font-medium text-gray-600">Gold</span></div>`; }
        }

        async function updateProfile(e) {
            e.preventDefault();
            const updates = {
                first_name: document.getElementById('profile-first-name').value, last_name: document.getElementById('profile-last-name').value,
                phone_number: document.getElementById('profile-phone-number').value, age: document.getElementById('profile-age').value,
                pin_code: document.getElementById('profile-pin-code').value, address: document.getElementById('profile-address').value,
            };
            const { error } = await window.authHelper.supabase.from('donor_profiles').update(updates).eq('id', currentUser.id);
            if (error) { alert('Failed to update profile: ' + error.message); } else { alert('Profile updated successfully!'); document.getElementById('user-name').textContent = updates.first_name; }
        }
        
        window.showRequestDecisionModal = function(id) { currentRequestId = id; document.getElementById('request-decision-modal').classList.remove('hidden'); };
        
        async function handleRequestDecision(decision) {
            if (!currentRequestId) return;
            try {
                await window.authHelper.supabase.from('donation_requests').update({ status: decision }).eq('id', currentRequestId);
                if (decision === 'accepted') {
                    const { data: request } = await window.authHelper.supabase.from('donation_requests').select('donation_id').eq('id', currentRequestId).single();
                    if (request) { await window.authHelper.supabase.from('donations').update({ status: 'accepted' }).eq('id', request.donation_id); }
                }
                document.getElementById('request-decision-modal').classList.add('hidden');
                alert(`Request ${decision} successfully!`);
                await updateDashboardStats();
                await loadDonationRequests();
            } catch (error) { alert('Failed to process request: ' + error.message); }
        }
        
        async function loadAcceptedDonationsForDelivery() {
            const contentArea = document.getElementById('delivery-process-content');
            contentArea.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            const { data: donations } = await window.authHelper.supabase.from('donations').select(`id, item_name, donation_requests!inner(ngo_id, status, ngo_profiles(ngo_name, address))`).eq('donor_id', currentUser.id).eq('status', 'accepted').eq('donation_requests.status', 'accepted');
            if (!donations || donations.length === 0) {
                contentArea.innerHTML = '<p class="text-center text-gray-500">You have no accepted donations ready for delivery.</p>'; return;
            }
            contentArea.innerHTML = `<div class="bg-white rounded-xl shadow-lg p-6 mb-6"><h2 class="text-xl font-semibold mb-1">1. Select Donation</h2><p class="text-sm text-gray-500 mb-4">Choose item to arrange delivery.</p><div id="accepted-donations-list" class="space-y-3"></div><div class="hidden mt-6" id="delivery-options-container"><h2 class="text-xl font-semibold mb-1">2. Choose Method</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="delivery-option border-2 rounded-xl p-4 cursor-pointer" data-option="volunteer"><h3 class="font-semibold text-lg">üöö I'll Deliver It Myself</h3><p class="text-sm text-gray-600">Drop off items at the NGO.</p></div><div class="delivery-option border-2 rounded-xl p-4 cursor-pointer" data-option="assigned"><h3 class="font-semibold text-lg">üì¶ Schedule a Pickup</h3><p class="text-sm text-gray-600">We'll assign a partner to collect.</p></div></div></div><div id="delivery-details-container" class="hidden mt-6"></div></div>`;
            const listContainer = document.getElementById('accepted-donations-list');
            donations.forEach(d => {
                const ngo = d.donation_requests[0].ngo_profiles;
                const card = document.createElement('div');
                card.className = 'border rounded-lg p-3 cursor-pointer hover:bg-gray-50 accepted-donation-card';
                card.dataset.donationId = d.id; card.dataset.ngoId = d.donation_requests[0].ngo_id; card.dataset.ngoName = ngo.ngo_name; card.dataset.ngoAddress = ngo.address;
                card.innerHTML = `<label class="flex items-center w-full cursor-pointer"><input type="radio" name="delivery-donation" class="mr-3 h-4 w-4 text-pink-600"><div<h4 class="font-medium">${d.item_name}</h4><p class="text-sm text-gray-600">To: ${ngo.ngo_name}</p></div></label>`;
                listContainer.appendChild(card);
            });
            document.querySelectorAll('.accepted-donation-card').forEach(c => c.addEventListener('click', () => {
                document.querySelectorAll('.accepted-donation-card').forEach(i => i.classList.remove('border-pink-400', 'bg-pink-50'));
                c.classList.add('border-pink-400', 'bg-pink-50'); c.querySelector('input').checked = true;
                document.getElementById('delivery-options-container').classList.remove('hidden');
                document.getElementById('delivery-details-container').classList.add('hidden').innerHTML = '';
            }));
            document.querySelectorAll('.delivery-option').forEach(o => o.addEventListener('click', function() {
                const card = document.querySelector('.accepted-donation-card.border-pink-400');
                if (!card) { alert("Please select a donation first."); return; }
                document.querySelectorAll('.delivery-option').forEach(i => i.classList.remove('border-pink-400', 'bg-pink-50'));
                this.classList.add('border-pink-400', 'bg-pink-50');
                showDeliveryDetails(this.dataset.option, card.dataset);
            }));
        }

        function showDeliveryDetails(option, data) {
            const container = document.getElementById('delivery-details-container');
            container.classList.remove('hidden');
            if (option === 'volunteer') {
                container.innerHTML = `<h3 class="text-xl font-semibold mt-4 border-t pt-4">3. Confirm Your Delivery</h3><p>Deliver to: <strong>${data.ngoName}</strong> at ${data.ngoAddress}</p><p class="text-sm my-4">Click below to confirm completion after you have dropped off the items.</p><button id="confirm-volunteer-delivery-btn" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">I Have Delivered This Item</button>`;
                document.getElementById('confirm-volunteer-delivery-btn').onclick = () => confirmVolunteerDelivery(data.donationId);
            } else if (option === 'assigned') {
                container.innerHTML = `<h3 class="text-xl font-semibold mt-4 border-t pt-4">3. Schedule Your Pickup</h3><div class="grid md:grid-cols-2 gap-4 my-4"><div><label for="pickup-date" class="block text-sm font-medium">Date</label><input type="date" id="pickup-date" class="mt-1 w-full p-2 border rounded-md"></div><div><label for="pickup-time" class="block text-sm font-medium">Time Slot</label><select id="pickup-time" class="mt-1 w-full p-2 border rounded-md bg-white"><option>9AM-12PM</option><option>12PM-3PM</option><option>3PM-6PM</option></select></div></div><div class="mb-4"><label class="flex items-center"><input type="checkbox" id="large-items" class="h-4 w-4 rounded text-pink-600 mr-2">Large item (e.g., furniture).</label></div><button id="schedule-pickup-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">Schedule Pickup</button>`;
                document.getElementById('schedule-pickup-btn').onclick = () => scheduleAssignedPickup(data.donationId, data.ngoId);
            }
        }

        async function confirmVolunteerDelivery(donationId) {
            if (!confirm("Are you sure you have delivered this item?")) return;
            try {
                await window.authHelper.supabase.from('donations').update({ status: 'delivered' }).eq('id', donationId);
                document.getElementById('delivery-success-message').textContent = "Thank you! Your contribution is complete.";
                document.getElementById('delivery-success-modal').classList.remove('hidden');
            } catch(err) { alert("Error: " + err.message); }
        }

        async function scheduleAssignedPickup(donationId, ngoId) {
            const pickupDate = document.getElementById('pickup-date').value;
            if (!pickupDate) { alert("Please select a date."); return; }
            const otp = Math.floor(1000 + Math.random() * 9000).toString();
            try {
                await window.authHelper.supabase.from('delivery_tracking').insert([{
                    donation_id: donationId, ngo_id: ngoId, donor_id: currentUser.id,
                    requires_multiple_partners: document.getElementById('large-items').checked,
                    pickup_scheduled_date: new Date(pickupDate), pickup_time_slot: document.getElementById('pickup-time').value,
                    donor_otp: otp, tracking_id: 'TRK' + Date.now().toString().slice(-8), status: 'pickup_pending', status_description: 'Awaiting partner assignment.'
                }]);
                await window.authHelper.supabase.from('donations').update({ status: 'in_transit' }).eq('id', donationId);
                document.getElementById('delivery-success-message').innerHTML = `Pickup scheduled! Provide this OTP to the delivery partner: <br><strong class="text-2xl tracking-widest my-2 block">${otp}</strong>`;
                document.getElementById('delivery-success-modal').classList.remove('hidden');
            } catch(err) { alert("Error: " + err.message); }
        }
        
        async function handleFeedbackSubmit(e) {
            e.preventDefault();
            const feedbackText = document.getElementById('feedback-text').value.trim();
            if (!feedbackText) { alert("Please enter feedback."); return; }
            try {
                await window.authHelper.supabase.from('feedback').insert({ user_id: currentUser.id, feedback_text: feedbackText });
                alert("Thank you for your feedback!");
                document.getElementById('feedback-form').reset();
            } catch (err) { alert("Error submitting feedback: " + err.message); }
        }
        
        async function loadRedemptionData() {
            const contentArea = document.getElementById('redemption-content');
            const badgesContainer = document.getElementById('redemption-badges');
            contentArea.innerHTML = `<p>Loading...</p>`;
            badgesContainer.innerHTML = '';
            try {
                const [{ count }, { data: redeemed }] = await Promise.all([
                    window.authHelper.supabase.from('donations').select('*', { count: 'exact', head: true }).eq('donor_id', currentUser.id),
                    window.authHelper.supabase.from('redeemed_rewards').select('milestone_level').eq('user_id', currentUser.id)
                ]);
                const redeemedLevels = redeemed.map(r => r.milestone_level);
                
                if (count >= 10) { badgesContainer.innerHTML += `<div class="flex flex-col items-center" title="Bronze: 10+ Donations"><i class="fas fa-medal text-orange-400 text-3xl"></i><span class="text-xs">Bronze</span></div>`; }
                if (count >= 20) { badgesContainer.innerHTML += `<div class="flex flex-col items-center" title="Silver: 20+ Donations"><i class="fas fa-medal text-gray-400 text-3xl"></i><span class="text-xs">Silver</span></div>`; }
                if (count >= 50) { badgesContainer.innerHTML += `<div class="flex flex-col items-center" title="Gold: 50+ Donations"><i class="fas fa-medal text-yellow-500 text-3xl"></i><span class="text-xs">Gold</span></div>`; }

                let availableRewardsHTML = '';
                const unclaimed = [];
                for (let i = 10; i <= count; i += 10) { if (!redeemedLevels.includes(i)) unclaimed.push(i); }
                if (unclaimed.length > 0) {
                    availableRewardsHTML = `<div class="mb-8 text-left"><h2 class="text-2xl font-semibold mb-4">Available Rewards</h2><div class="space-y-4">` + 
                    unclaimed.map(level => `<div class="bg-white rounded-lg p-4 flex justify-between items-center shadow"><div><h3 class="font-bold text-lg text-pink-600">Reward: ${level} Donations!</h3><p class="text-sm text-gray-500">Thank you!</p></div><button onclick="handleRedeem(${level})" class="bg-pink-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-700">Redeem</button></div>`).join('') + `</div></div>`;
                } else {
                     availableRewardsHTML = `<div class="mb-8 text-left p-4 bg-white rounded-lg shadow"><h2 class="text-2xl font-semibold mb-2">Available Rewards</h2><p class="text-gray-500">No new rewards to claim.</p></div>`;
                }
                const nextGoal = Math.floor(count / 10) * 10 + 10;
                const progress = (count % 10) * 10;
                const nextMilestoneHTML = `<div class="text-left mt-6 border-t pt-6"><h2 class="text-2xl font-semibold">Next Milestone</h2><p class="mt-2 mb-4 text-gray-600">${nextGoal - count} donations away!</p><div class="flex justify-between text-sm mb-1"><span>Progress</span><span>${count}/${nextGoal}</span></div><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div></div>`;
                contentArea.innerHTML = availableRewardsHTML + nextMilestoneHTML;
            } catch (err) { contentArea.innerHTML = `<p class="text-red-500">Could not load data: ${err.message}</p>`; }
        }
        
        window.handleRedeem = async function(level) {
            if (!confirm(`Redeem the reward for ${level} donations?`)) return;
            try {
                await window.authHelper.supabase.from('redeemed_rewards').insert({ user_id: currentUser.id, milestone_level: level });
                alert(`Reward redeemed! We'll be in touch.`);
                loadRedemptionData();
            } catch (err) { alert("Error: " + err.message); }
        }
        
        // UTILITY FUNCTIONS
        function getStatusColor(status) { const colors = {'available': 'text-green-600', 'requested': 'text-yellow-600', 'accepted': 'text-blue-600', 'in_transit': 'text-purple-600', 'delivered': 'text-gray-600'}; return colors[status] || 'text-gray-600'; }
        function getRequestStatusColor(status) { const colors = {'pending': 'bg-yellow-100 text-yellow-800', 'accepted': 'bg-green-100 text-green-800', 'rejected': 'bg-red-100 text-red-800', 'cancelled': 'bg-gray-100 text-gray-800'}; return colors[status] || 'bg-gray-100 text-gray-800'; }
        function getTrackingStatusColor(status) { const colors = {'pickup_pending': 'bg-yellow-100 text-yellow-800', 'picked_up': 'bg-blue-100 text-blue-800', 'in_transit': 'bg-purple-100 text-purple-800', 'delivered': 'bg-green-100 text-green-800'}; return colors[status] || 'bg-gray-100 text-gray-800'; }

      });
    </script>
  </body>
</html>