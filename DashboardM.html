<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body
    class="bg-gradient-to-r from-pink-100 via-rose-100 to-orange-100 min-h-screen"
  >
    <div class="flex min-h-screen">
      <aside class="w-64 flex-shrink-0 bg-amber-50 shadow-lg flex flex-col">
        <div class="p-6 text-2xl font-bold text-center border-b">
          üå±Care<span class="text-pink-600">Bloom</span>
        </div>
        <nav class="flex-grow p-4 space-y-2">
          <a
            href="#"
            id="nav-dashboard"
            class="nav-link flex items-center px-4 py-3 font-semibold text-white bg-pink-500 rounded-lg"
          >
            <i class="fas fa-tachometer-alt w-6 text-center mr-3"></i>Dashboard
          </a>
          <a
            href="#"
            id="nav-donations"
            class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 hover:text-gray-800 rounded-lg transition-colors duration-75"
          >
            <i class="fas fa-gift w-6 text-center mr-3"></i>My Donations
          </a>
          <a
            href="#"
            id="nav-profile"
            class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 hover:text-gray-800 rounded-lg transition-colors duration-75"
          >
            <i class="fas fa-user w-6 text-center mr-3"></i>Profile
          </a>
          <a
            href="#"
            id="nav-settings"
            class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 hover:text-gray-800 rounded-lg transition-colors duration-75"
          >
            <i class="fas fa-cog w-6 text-center mr-3"></i>Settings
          </a>
        </nav>
        <div class="p-4 border-t">
          <a
            href="#"
            id="nav-logout"
            class="flex items-center px-4 py-3 text-gray-600 hover:bg-pink-100 hover:text-gray-800 rounded-lg transition-colors duration-75"
          >
            <i class="fas fa-sign-out-alt w-6 text-center mr-3"></i>Logout
          </a>
        </div>
      </aside>

      <main class="flex-1 p-6">
        <div id="view-dashboard">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-6">
            <header class="flex justify-between items-center">
              <div>
                <h1 class="font-bold text-black text-3xl">
                  Welcome, <span id="user-name">User</span>! üå∑
                </h1>
                <p class="mt-1.5 text-xl font-normal text-black">
                  Your Garden is Flourishing! You have helped
                  <span id="ngo-count">0</span> NGOs and Touched
                  <span id="lives-touched">0</span> Lives! üéóÔ∏è
                </p>
              </div>
            </header>
          </div>

          <section
            class="donation-form bg-amber-50 rounded-2xl shadow-xl mt-6 p-8"
          >
            <h2 class="text-2xl text-black font-bold mb-6">
              Plant a New Seed (Make a new donation) üå±
            </h2>
            <form
              id="donation-form"
              class="space-y-6"
              autocomplete="off"
              onsubmit="return false;"
            >
              <div>
                <label
                  for="item-name"
                  class="block text-xl text-black font-medium mb-2"
                  >Item Name</label
                >
                <input
                  id="item-name"
                  type="text"
                  required
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                  placeholder="e.g., Winter Jacket"
                />
              </div>

              <div>
                <label
                  for="quantity-required"
                  class="block text-xl text-black font-medium mb-2"
                  >Quantity</label
                >
                <input
                  id="quantity-required"
                  type="text"
                  required
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                  placeholder="e.g., 5 jackets"
                />
              </div>

              <div>
                <label
                  for="item-images"
                  class="block text-xl text-black font-medium mb-2"
                  >Add Photos</label
                >
                <div
                  class="image-upload-area relative flex flex-col justify-center items-center p-8 border-2 border-dashed border-pink-500 rounded-lg cursor-pointer bg-pink-50 hover:bg-pink-100 transition-colors duration-200 min-h-[200px]"
                >
                  <input
                    type="file"
                    name="item-images"
                    id="item-images"
                    accept="image/*"
                    multiple
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                  />
                  <div class="text-center">
                    <i
                      class="fa-solid fa-camera text-4xl text-pink-600 mb-2"
                    ></i>
                    <p class="text-gray-700">Drag & Drop or click to browse</p>
                    <p class="text-sm text-gray-500 mt-1">Max file size: 5MB</p>
                  </div>
                  <div
                    id="image-preview-container"
                    class="flex flex-wrap gap-4 mt-4 justify-center"
                  ></div>
                </div>
              </div>

              <div>
                <label
                  for="item-description"
                  class="block text-xl text-black font-medium mb-2"
                  >Item Description</label
                >
                <textarea
                  id="item-description"
                  rows="4"
                  required
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                  placeholder="Describe the item's condition, size, etc."
                ></textarea>
              </div>

              <div>
                <label class="block text-xl text-black font-medium mb-2"
                  >Select Tag</label
                >
                <div class="flex flex-wrap gap-2" id="tag-buttons">
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Books
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Clothes
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Toys
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Utensils
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Electronics
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Small furniture
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Sports Equipment
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Bedding & Blankets
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Towels
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Baby Gear (strollers, car seats)
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Feminine Hygiene Products
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    First-Aid Supplies
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Medical Aids (Wheelchairs, Crutches)
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Tools & Hardware
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Pet Supplies
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Cleaning Supplies
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Home Appliances (Small)
                  </button>
                  <button
                    type="button"
                    class="tag-btn bg-white text-pink-600 font-medium rounded-2xl px-4 py-2 hover:bg-pink-500 hover:text-white transition-colors"
                  >
                    Others
                  </button>
                </div>
                <input type="hidden" id="selected-tag" />
              </div>

              <div>
                <button
                  id="donate-item-btn"
                  type="button"
                  class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 transition-colors"
                >
                  Donate Item
                </button>
              </div>
            </form>
          </section>
        </div>

        <div id="view-donations" class="hidden">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
            <h1 class="font-bold text-black text-3xl mb-6">My Donations üéÅ</h1>
            <div
              id="donations-container"
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
            >
              <p
                id="no-donations-message"
                class="col-span-full text-center text-gray-500"
              >
                You haven't made any donations yet.
              </p>
            </div>
          </div>
        </div>

        <div id="view-profile" class="hidden">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
            <h1 class="font-bold text-black text-3xl mb-6">My Profile üë§</h1>
            <form id="profile-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="profile-first-name"
                    class="block text-xl text-black font-medium mb-2"
                    >First Name</label
                  >
                  <input
                    id="profile-first-name"
                    type="text"
                    required
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                  />
                </div>
                <div>
                  <label
                    for="profile-last-name"
                    class="block text-xl text-black font-medium mb-2"
                    >Last Name</label
                  >
                  <input
                    id="profile-last-name"
                    type="text"
                    required
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                  />
                </div>
              </div>
              <div>
                <label
                  for="profile-email"
                  class="block text-xl text-black font-medium mb-2"
                  >Email</label
                >
                <input
                  id="profile-email"
                  type="email"
                  disabled
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-gray-100 cursor-not-allowed"
                />
              </div>
              <div>
                <label
                  for="profile-phone-number"
                  class="block text-xl text-black font-medium mb-2"
                  >Phone Number</label
                >
                <input
                  id="profile-phone-number"
                  type="tel"
                  required
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                />
              </div>
              <div>
                <label
                  for="profile-age"
                  class="block text-xl text-black font-medium mb-2"
                  >Age</label
                >
                <input
                  id="profile-age"
                  type="number"
                  required
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                />
              </div>
              <div>
                <label
                  for="profile-pin-code"
                  class="block text-xl text-black font-medium mb-2"
                  >Pincode</label
                >
                <input
                  id="profile-pin-code"
                  type="text"
                  required
                  class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-400"
                />
              </div>
              <div>
                <button
                  id="update-profile-btn"
                  type="submit"
                  class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 transition-colors"
                >
                  Update Profile
                </button>
              </div>
            </form>
          </div>
        </div>

        <div id="view-settings" class="hidden">
          <div class="bg-amber-50 rounded-2xl shadow-xl w-full p-8">
            <h1 class="font-bold text-black text-3xl mb-6">Settings</h1>
            <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
              <div>
                <h3 class="text-xl font-semibold mb-4">Notifications</h3>
                <div class="flex items-center justify-between">
                  <p>Email me when a donation is accepted</p>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="notification-accepted" class="sr-only peer" />
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-pink-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                  </label>
                </div>
                <div class="flex items-center justify-between mt-4">
                  <p>Send me updates about new NGO campaigns</p>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="notification-campaigns" class="sr-only peer" />
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-pink-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                  </label>
                </div>
              </div>
              <div class="border-t pt-6">
                <h3 class="text-xl font-semibold mb-4">Account</h3>
                <div class="flex space-x-4">
                  <button id="change-password-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                    Change Password
                  </button>
                  <button id="delete-account-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">
                    Delete Account
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div
      id="confirmation-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"
    >
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
        <div
          class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-pink-100 mb-4"
        >
          <i class="fas fa-hand-holding-heart text-pink-600 text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900">Confirm Donation</h3>
        <p class="mt-2 text-sm text-gray-500">
          Are you sure you want to list this item for donation?
        </p>
        <div class="mt-6 flex justify-center gap-4">
          <button
            id="confirm-donate-btn"
            type="button"
            class="bg-pink-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-pink-700 transition-colors"
          >
            Yes, Donate
          </button>
          <button
            id="cancel-donate-btn"
            type="button"
            class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors"
          >
            No, Cancel
          </button>
        </div>
      </div>
    </div>

    <div
      id="success-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"
    >
      <div
        id="success-modal-content"
        class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center transform transition-all scale-95 opacity-0"
      >
        <div
          class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"
        >
          <i class="fas fa-check text-green-600 text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900">Success!</h3>
        <p class="mt-2 text-sm text-gray-500">
          Item donated successfully! Check your donations in the 'My Donations'
          tab.
        </p>
        <div class="mt-6">
          <button
            id="success-ok-btn"
            type="button"
            class="w-full bg-pink-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-pink-700 transition-colors"
          >
            Okay
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const supabaseUrl = "https://hrlqhglfzgnoqpaueacb.supabase.co";
        const supabaseKey =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhybHFoZ2xmemdub3FwYXVlYWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MjEzOTMsImV4cCI6MjA3NDM5NzM5M30.q_ukDX8J-cAZoCZhGnLMas8_eZmsXtFN0STRoEyxGsA";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let userSettings = {};

        // Check user session and ensure profile exists on page load
        async function ensureProfileExists() {
          const {
            data: { user },
          } = await supabase.auth.getUser();
          if (!user) {
            window.location.href = "LoginSignUp.html";
            return;
          }

          currentUser = user;

          // Check if a profile exists for the user
          const { data: profile, error } = await supabase
            .from("donor_Profiles")
            .select("*")
            .eq("id", user.id)
            .single();

          if (error && error.code === "PGRST116") {
            alert("Please complete your profile to access the dashboard.");
            window.location.href = "CreatProfile.html";
          } else if (error) {
            console.error("Error fetching profile:", error);
            alert("An error occurred. Please try again later.");
          } else {
            // Profile exists, load settings and update dashboard
            await loadUserSettings();
            updateDashboardStats();
          }
        }

        // Load user settings from database
        async function loadUserSettings() {
          if (!currentUser) return;

          const { data: profile, error } = await supabase
            .from("donor_Profiles")
            .select("notification_preferences, settings")
            .eq("id", currentUser.id)
            .single();

          if (error && error.code !== "PGRST116") {
            console.error("Error loading settings:", error);
          }

          userSettings = {
            notification_accepted: true,
            notification_campaigns: false,
            ...profile?.notification_preferences,
            ...profile?.settings,
          };

          document.getElementById("notification-accepted").checked =
            userSettings.notification_accepted;
          document.getElementById("notification-campaigns").checked =
            userSettings.notification_campaigns;
        }

        // Save user settings to database
        async function saveUserSettings() {
          if (!currentUser) return;

          const { error } = await supabase
            .from("donor_Profiles")
            .update({
              notification_preferences: {
                notification_accepted: userSettings.notification_accepted,
                notification_campaigns: userSettings.notification_campaigns,
              },
              settings: userSettings,
              updated_at: new Date().toISOString(),
            })
            .eq("id", currentUser.id);

          if (error) {
            console.error("Error saving settings:", error);
            return false;
          }
          return true;
        }

        // Logout handler
        document
          .getElementById("nav-logout")
          .addEventListener("click", async (event) => {
            event.preventDefault();
            const { error } = await supabase.auth.signOut();
            if (error) {
              alert("Failed to log out: " + error.message);
            } else {
              window.location.href = "LoginSignUp.html";
            }
          });

        // Image preview functionality
        const fileInput = document.getElementById("item-images");
        const previewContainer = document.getElementById(
          "image-preview-container"
        );
        let fileStore = new DataTransfer();

        fileInput.addEventListener("change", (event) => {
          for (const file of event.target.files) fileStore.items.add(file);
          fileInput.files = fileStore.files;
          renderPreviews();
        });

        function renderPreviews() {
          previewContainer.innerHTML = "";
          for (let i = 0; i < fileStore.files.length; i++) {
            const file = fileStore.files[i];
            if (!file.type.startsWith("image/")) continue;
            const reader = new FileReader();
            reader.onload = (e) => {
              const wrapper = document.createElement("div");
              wrapper.className = "relative w-24 h-24";
              const img = document.createElement("img");
              img.src = e.target.result;
              img.className =
                "w-full h-full object-cover rounded-lg border-2 border-gray-200";
              wrapper.appendChild(img);
              const removeBtn = document.createElement("button");
              removeBtn.type = "button";
              removeBtn.innerHTML = "&times;";
              removeBtn.className =
                "absolute top-0 right-0 -mt-2 -mr-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs font-bold hover:bg-red-700 transition-transform transform hover:scale-110";
              removeBtn.onclick = () => removeFile(i);
              wrapper.appendChild(removeBtn);
              previewContainer.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
          }
        }

        function removeFile(index) {
          const newFileStore = new DataTransfer();
          for (let i = 0; i < fileStore.files.length; i++) {
            if (i !== index) newFileStore.items.add(fileStore.files[i]);
          }
          fileStore = newFileStore;
          fileInput.files = fileStore.files;
          renderPreviews();
        }

        // Tag buttons functionality
        const tagButtons = document.querySelectorAll(".tag-btn");
        const selectedTagInput = document.getElementById("selected-tag");
        let selectedTagBtn = null;
        tagButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            if (selectedTagBtn === btn) {
              btn.classList.remove("bg-pink-500", "text-white");
              btn.classList.add("bg-white", "text-pink-600");
              selectedTagBtn = null;
              selectedTagInput.value = "";
            } else {
              tagButtons.forEach((b) => {
                b.classList.remove("bg-pink-500", "text-white");
                b.classList.add("bg-white", "text-pink-600");
              });
              btn.classList.add("bg-pink-500", "text-white");
              btn.classList.remove("bg-white", "text-pink-600");
              selectedTagBtn = btn;
              selectedTagInput.value = btn.textContent.trim();
            }
          });
        });

        // View switching functionality
        const navLinks = document.querySelectorAll(".nav-link");
        const views = {
          dashboard: document.getElementById("view-dashboard"),
          donations: document.getElementById("view-donations"),
          profile: document.getElementById("view-profile"),
          settings: document.getElementById("view-settings"),
        };

        function switchView(viewName) {
          for (const key in views) {
            if (views[key]) {
              views[key].classList.add("hidden");
            }
          }
          if (views[viewName]) {
            views[viewName].classList.remove("hidden");
          }
        }

        navLinks.forEach((link) => {
          link.addEventListener("click", (event) => {
            event.preventDefault();
            const viewName = link.id.split("-")[1];
            navLinks.forEach((nav) => {
              nav.classList.remove("bg-pink-500", "text-white");
              nav.classList.add("text-gray-600");
            });
            link.classList.add("bg-pink-500", "text-white");
            link.classList.remove("text-gray-600");

            switchView(viewName);
            if (viewName === "donations") {
              fetchDonations();
            } else if (viewName === "profile") {
              fetchProfile();
            } else if (viewName === "settings") {
              loadUserSettings();
            }
          });
        });

        // Modal and form handling
        const donateItemBtn = document.getElementById("donate-item-btn");
        const confirmationModal = document.getElementById("confirmation-modal");
        const cancelDonateBtn = document.getElementById("cancel-donate-btn");
        const confirmDonateBtn = document.getElementById("confirm-donate-btn");
        const successModal = document.getElementById("success-modal");
        const successModalContent = document.getElementById(
          "success-modal-content"
        );
        const successOkBtn = document.getElementById("success-ok-btn");
        const donationForm = document.getElementById("donation-form");
        const profileForm = document.getElementById("profile-form");
        const donationsContainer =
          document.getElementById("donations-container");
        const noDonationsMessage =
          document.getElementById("no-donations-message");

        donateItemBtn.addEventListener("click", () => {
          if (!donationForm.checkValidity()) {
            donationForm.reportValidity();
            return;
          }
          if (!selectedTagInput.value) {
            alert("Please select a tag.");
            return;
          }
          confirmationModal.classList.remove("hidden");
        });

        cancelDonateBtn.addEventListener("click", () => {
          confirmationModal.classList.add("hidden");
        });

        confirmDonateBtn.addEventListener("click", async () => {
          confirmationModal.classList.add("hidden");
          const success = await submitDonation();
          if (success) {
            successModal.classList.remove("hidden");
            setTimeout(() => {
              successModalContent.classList.remove("scale-95", "opacity-0");
            }, 10);
          }
        });

        successOkBtn.addEventListener("click", () => {
          successModalContent.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            successModal.classList.add("hidden");
          }, 300);
          donationForm.reset();
          previewContainer.innerHTML = "";
          fileStore = new DataTransfer();
          tagButtons.forEach((btn) => {
            btn.classList.remove("bg-pink-500", "text-white");
            btn.classList.add("bg-white", "text-pink-600");
          });
          selectedTagBtn = null;
          selectedTagInput.value = "";
          updateDashboardStats(); // Refresh stats after new donation
        });

        // Submit donation to Supabase
        async function submitDonation() {
          try {
            if (!currentUser) {
              alert("Please log in first.");
              return false;
            }

            const itemName = document.getElementById("item-name").value.trim();
            const quantityRequired = document
              .getElementById("quantity-required")
              .value.trim();
            const itemDescription = document
              .getElementById("item-description")
              .value.trim();
            const tag = selectedTagInput.value;

            let imageUrls = [];
            for (let i = 0; i < fileStore.files.length; i++) {
              const file = fileStore.files[i];
              const ext = file.name.split(".").pop();
              const fileName = `uploads/${
                currentUser.id
              }/${Date.now()}-${i}.${ext}`;
              const { error: uploadError } = await supabase.storage
                .from("item_images")
                .upload(fileName, file);
              if (uploadError) {
                alert(
                  `Failed to upload image ${file.name}: ${uploadError.message}`
                );
                return false;
              }
              const { data } = supabase.storage
                .from("item_images")
                .getPublicUrl(fileName);
              imageUrls.push(data.publicUrl);
            }

            const { error: insertError } = await supabase.from("donations").insert([
              {
                item_name: itemName,
                quantity_required: quantityRequired,
                description: itemDescription,
                item_image_url: imageUrls.join(","),
                item_tag: tag,
                donor_id: currentUser.id,
                created_at: new Date().toISOString(),
                status: "pending", // Add status field
              },
            ]);

            if (insertError) {
              alert(`Failed to post donation: ${insertError.message}`);
              return false;
            }
            return true;
          } catch (error) {
            alert(`An error occurred: ${error.message}`);
            return false;
          }
        }

        // Update dashboard statistics
        async function updateDashboardStats() {
          if (!currentUser) return;

          const { data: profile, error: profileError } = await supabase
            .from("donor_Profiles")
            .select("first_name")
            .eq("id", currentUser.id)
            .single();
          if (profile && profile.first_name) {
            document.getElementById("user-name").textContent =
              profile.first_name;
          }

          const { data: donations, error: donationsError } = await supabase
            .from("donations")
            .select("id, quantity_required, status")
            .eq("donor_id", currentUser.id);

          if (donations) {
            const acceptedDonations = donations.filter(
              (d) => d.status === "accepted"
            );
            const ngoCount = new Set(acceptedDonations.map((d) => d.id)).size;
            const livesTouched = acceptedDonations.reduce(
              (sum, d) => sum + parseInt(d.quantity_required || 0, 10),
              0
            );
            document.getElementById("ngo-count").textContent = ngoCount;
            document.getElementById("lives-touched").textContent =
              livesTouched;
          }
        }

        // Fetch and display user donations
        async function fetchDonations() {
          if (!currentUser) {
            donationsContainer.innerHTML = `<p class="col-span-full text-center text-gray-500">Please log in to see your donations.</p>`;
            return;
          }

          const { data: donations, error } = await supabase
            .from("donations")
            .select("*")
            .eq("donor_id", currentUser.id)
            .order("created_at", { ascending: false });

          if (error) {
            donationsContainer.innerHTML = `<p class="col-span-full text-center text-red-500">Error fetching donations: ${error.message}</p>`;
            return;
          }

          donationsContainer.innerHTML = "";
          if (donations.length === 0) {
            donationsContainer.appendChild(noDonationsMessage);
            noDonationsMessage.classList.remove("hidden");
          } else {
            noDonationsMessage.classList.add("hidden");
            donations.forEach((donation) => {
              const donationCard = document.createElement("div");
              const imageUrls = donation.item_image_url
                ? donation.item_image_url.split(",")
                : [];
              const firstImage =
                imageUrls.length > 0
                  ? imageUrls[0]
                  : "https://placehold.co/400x300";
              const donationDate = new Date(
                donation.created_at
              ).toLocaleDateString();
              const statusColor =
                donation.status === "accepted"
                  ? "bg-green-100 text-green-700"
                  : donation.status === "rejected"
                  ? "bg-red-100 text-red-700"
                  : "bg-yellow-100 text-yellow-700";

              donationCard.className =
                "bg-white rounded-xl shadow-md p-6 flex flex-col items-start space-y-4 transition-transform transform hover:scale-105";
              donationCard.innerHTML = `
                <div class="w-full h-48 bg-gray-200 rounded-lg overflow-hidden">
                    <img src="${firstImage}" alt="${
                donation.item_name
              }" class="w-full h-full object-cover">
                </div>
                <div class="flex flex-col flex-grow w-full">
                    <span class="${statusColor} text-xs font-semibold px-2.5 py-0.5 rounded-full inline-block mb-2">${
                donation.status || "pending"
              }</span>
                    <span class="bg-pink-100 text-pink-700 text-xs font-semibold px-2.5 py-0.5 rounded-full inline-block mb-2">${
                      donation.item_tag
                    }</span>
                    <h3 class="text-xl font-semibold text-gray-800">${
                      donation.item_name
                    }</h3>
                    <p class="text-sm text-gray-500 mt-1">Quantity: ${
                      donation.quantity_required
                    }</p>
                    <p class="text-sm text-gray-600 mt-2">${
                      donation.description
                    }</p>
                    <p class="text-xs text-gray-400 mt-2">Donated on: ${donationDate}</p>
                </div>
              `;
              donationsContainer.appendChild(donationCard);
            });
          }
        }

        // Fetch and display user profile
        async function fetchProfile() {
          if (!currentUser) {
            alert("Please log in to view your profile.");
            return;
          }
          const { data, error } = await supabase
            .from("donor_Profiles")
            .select("*")
            .eq("id", currentUser.id)
            .single();

          if (error && error.code === "PGRST116") {
            alert("Please complete your profile first.");
            window.location.href = "CreatProfile.html";
          } else if (error) {
            console.error("Error fetching profile:", error);
            alert("An error occurred while fetching your profile.");
          } else {
            document.getElementById("profile-first-name").value =
              data.first_name || "";
            document.getElementById("profile-last-name").value =
              data.last_name || "";
            document.getElementById("profile-email").value =
              currentUser.email || "";
            document.getElementById("profile-phone-number").value =
              data.phone_number || "";
            document.getElementById("profile-age").value = data.age || "";
            document.getElementById("profile-pin-code").value =
              data.pin_code || "";
          }
        }

        profileForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!currentUser) {
            alert("You must be logged in to update your profile.");
            return;
          }

          const firstName = document
            .getElementById("profile-first-name")
            .value.trim();
          const lastName = document
            .getElementById("profile-last-name")
            .value.trim();
          const phoneNumber = document
            .getElementById("profile-phone-number")
            .value.trim();
          const age = parseInt(
            document.getElementById("profile-age").value.trim(),
            10
          );
          const pinCode = document
            .getElementById("profile-pin-code")
            .value.trim();

          const updates = {
            first_name: firstName,
            last_name: lastName,
            phone_number: phoneNumber,
            age: age,
            pin_code: pinCode,
            updated_at: new Date().toISOString(),
          };

          const { error } = await supabase
            .from("donor_Profiles")
            .update(updates)
            .eq("id", currentUser.id);

          if (error) {
            console.error("Error updating profile:", error);
            alert(
              "An error occurred while updating your profile. Please try again."
            );
          } else {
            alert("Profile updated successfully! üéâ");
            updateDashboardStats(); // Refresh the user's name on the dashboard
          }
        });

        // Settings Management
        document
          .getElementById("notification-accepted")
          .addEventListener("change", async (event) => {
            userSettings.notification_accepted = event.target.checked;
            const success = await saveUserSettings();
            if (success) {
              alert("Notification setting saved.");
            }
          });

        document
          .getElementById("notification-campaigns")
          .addEventListener("change", async (event) => {
            userSettings.notification_campaigns = event.target.checked;
            const success = await saveUserSettings();
            if (success) {
              alert("Notification setting saved.");
            }
          });

        document
          .getElementById("change-password-btn")
          .addEventListener("click", async () => {
            if (!currentUser) {
              alert("You must be logged in to change your password.");
              return;
            }
            const { error } = await supabase.auth.resetPasswordForEmail(
              currentUser.email
            );
            if (error) {
              alert("Error sending password reset email: " + error.message);
            } else {
              alert(
                "A password reset link has been sent to your email. Please check your inbox."
              );
            }
          });

        document
          .getElementById("delete-account-btn")
          .addEventListener("click", async () => {
            if (!currentUser) {
              alert("You must be logged in to delete your account.");
              return;
            }
            const confirmDelete = confirm(
              "Are you sure you want to delete your account? This action is irreversible."
            );
            if (confirmDelete) {
              const { error } = await supabase.auth.admin.deleteUser(
                currentUser.id
              );
              if (error) {
                alert("Failed to delete account. Please try again later.");
                console.error("Error deleting user:", error);
              } else {
                alert(
                  "Your account has been successfully deleted. Thank you for your support. üëã"
                );
                window.location.href = "LoginSignUp.html";
              }
            }
          });

        // Initial load
        ensureProfileExists();
      });
    </script>
  </body>
</html>